name: Build Client Desktop Packages (Manual)

on:
  workflow_dispatch:
    inputs:
      client:
        description: 'Client to build (e.g., bechem)'
        required: true
        type: string
        default: 'bechem'
      version:
        description: 'Client version (e.g., 1.0.0)'
        required: true
        type: string
      platforms:
        description: 'Platforms to build'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - windows
          - macos
          - linux
      release:
        description: 'Create GitHub Release after successful build'
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build ${{ inputs.client }} v${{ inputs.version }}
    uses: ./.github/workflows/build-client-reusable.yml
    with:
      client: ${{ inputs.client }}
      version: ${{ inputs.version }}
      platforms: ${{ inputs.platforms }}

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: inputs.release == true && needs.build.result == 'success'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: client/${{ inputs.client }}

      - name: List all available artifacts (diagnostic)
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            console.log('=== All Artifacts in this Workflow Run ===');
            if (artifacts.data.artifacts.length === 0) {
              console.log('âŒ No artifacts found in this workflow run!');
              console.log('This means the build job did not upload any artifacts.');
            } else {
              console.log(`Found ${artifacts.data.artifacts.length} artifact(s):`);
              artifacts.data.artifacts.forEach(artifact => {
                console.log(`  - ${artifact.name} (${artifact.size_in_bytes} bytes)`);
              });
            }

      - name: Download all artifacts
        id: download-artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: ${{ inputs.client }}-*-v${{ inputs.version }}
          merge-multiple: false

      - name: Display artifact structure
        run: |
          echo "=== Artifact Download Diagnostics ==="
          echo "Expected pattern: ${{ inputs.client }}-*-v${{ inputs.version }}"
          echo "Examples: ${{ inputs.client }}-mac-v${{ inputs.version }}, ${{ inputs.client }}-win-v${{ inputs.version }}, ${{ inputs.client }}-linux-v${{ inputs.version }}"
          echo ""
          echo "Current directory contents:"
          ls -la
          echo ""

          if [ -d "release-artifacts" ]; then
            echo "âœ“ release-artifacts directory exists"
            echo "Directory structure:"
            ls -R release-artifacts/

            # Count actual artifact directories (exclude debug logs)
            ARTIFACT_COUNT=$(find release-artifacts -mindepth 1 -maxdepth 1 -type d ! -name 'npm-debug-log-*' | wc -l)
            echo ""
            echo "Found $ARTIFACT_COUNT build artifact(s)"

            if [ "$ARTIFACT_COUNT" -eq 0 ]; then
              echo ""
              echo "ERROR: No build artifacts found!"
              echo "This usually means:"
              echo "  1. The build job failed (check build job logs above)"
              echo "  2. No platforms were built (check platform filter)"
              echo "  3. Artifact names don't match the expected pattern"
              exit 1
            fi
          else
            echo "âœ— release-artifacts directory does NOT exist"
            echo ""
            echo "ERROR: actions/download-artifact did not create the directory"
            echo "This means NO artifacts matched the pattern: ${{ inputs.client }}-*-v${{ inputs.version }}"
            echo ""
            echo "Possible causes:"
            echo "  1. Build job failed before uploading artifacts"
            echo "  2. Version mismatch in artifact names"
            echo "  3. Client name mismatch in artifact names"
            exit 1
          fi

      - name: Flatten artifacts for release
        run: |
          echo "Flattening artifact structure..."
          mkdir -p release-files
          # Copy all files from artifact subdirectories to release-files
          find release-artifacts -type f \( -name '*.dmg' -o -name '*.exe' -o -name '*.AppImage' -o -name '*.zip' \) -exec cp {} release-files/ \;
          echo "Files to release:"
          ls -lh release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.client }}/v${{ inputs.version }}
          name: ${{ inputs.client }} v${{ inputs.version }}
          draft: false
          prerelease: false
          files: release-files/*
          generate_release_notes: true
          body: |
            ## ${{ inputs.client }} v${{ inputs.version }}

            Desktop packages for ${{ inputs.client }} client.

            **Client Version**: ${{ inputs.version }}
            **Build Date**: ${{ github.event.head_commit.timestamp }}
            **Branch**: client/${{ inputs.client }}

            ### Downloads

            - **macOS**: Download the `.dmg` file
            - **Windows**: Download the `.exe` file
            - **Linux**: Download the `.AppImage` file

            ### Installation

            1. Download the appropriate file for your platform
            2. Run the installer
            3. Launch the application

            ---

            ðŸ¤– Generated with [GitHub Actions](https://github.com/features/actions)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version matrix
        if: success()
        run: |
          # Get core version from client config
          CORE_VERSION=$(cat config/clients/${{ inputs.client }}.json | grep -o '"core"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)

          # Update version matrix
          chmod +x scripts/update-version-matrix.sh
          ./scripts/update-version-matrix.sh ${{ inputs.client }} ${{ inputs.version }} "$CORE_VERSION" Production "Release via GitHub Actions"

          # Commit and push version matrix update
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/version-matrix.md
          git commit -m "Update version matrix: ${{ inputs.client }} v${{ inputs.version }}" || echo "No changes to commit"
          git push origin client/${{ inputs.client }} || echo "No changes to push"
